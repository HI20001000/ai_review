# SQL 靜態分析規則

`server/lib/sqlAnalyzer.js` 內建的 SQL 靜態分析器會在儲存或顯示報告前，自動針對 `.sql` 檔案執行下列規則檢查。若違反任一規則，分析結果會在報告中列出對應的問題、行號與修正建議欄位（目前為空字串，預留給後續的 Dify 產生式建議）。

1. **命名需採用英文詞彙**：所有對象名稱（含資料表、欄位、參數、變數等）必須使用英文單字、片語或縮寫，禁止使用無意義的符號或漢語拼音。
2. **名稱需具描述性**：所有對象名稱必須清晰易懂，能準確傳達實際用途或意義。
3. **名稱長度建議**：對象名稱建議最多由三個單字組成，並以底線（`_`）分隔各單字。
4. **加上前綴識別**：建議依對象類型加入前綴，例如：資料表使用 `T_`、儲存過程使用 `P_`、函式使用 `F_`、檢視使用 `V_`。
5. **完整註解**：所有資料庫對象（資料表、檢視、儲存過程、函式等）都必須撰寫註解；欄位與複雜的 DML 語句也應加上說明，利於閱讀與維運。
6. **指令大寫**：建議建表、檢視、函式、儲存過程等腳本的 SQL 關鍵字全部使用大寫。
7. **遵循正規化**：建立資料表時需符合第三正規化，但可視需求保留冗餘欄位。
8. **預留擴充欄位**：建立大型資料表時，建議預先設計五個擴充欄位，例如 `EXTEND_1` 等，以利後續維護。
9. **索引數量控制**：常用查詢欄位建議建立索引，但除主鍵以外，每張表的索引數量不宜超過三個。
10. **檢視層級限制**：檢視嵌套深度不可超過三層。
11. **函式層級限制**：函式嵌套不宜超過三層，最佳實務為兩層內，包含自訂與系統函式。
12. **函式長度限制**：自訂函式建議程式碼行數不超過 200 行。
13. **禁止觸發器**：不允許建立或使用觸發器。
14. **儲存過程格式**：撰寫儲存過程時，需遵循縮排與格式規範（運算子後空格、對齊、欄位均使用別名等），提交檔案應為 Unix 行尾且採 UTF-8 無 BOM；中介表不得使用 `TMP_TMP_TMP` 作為前綴，需依命名規則命名。
15. **歷史表命名**：歷史表名稱需以 `_HIS` 結尾，且第一個會計日期欄位名稱統一為 `DT_DATE`。
16. **全表刪除限制**：刪除整張表時應使用 `TRUNCATE`，不可使用 `DELETE`。
17. **批次載入規範**：執行批次 `LOAD` 時需加入 `NONRECOVERABLE`，並遵循分批導入、索引管理、`COMMIT` 與 `MSG` 記錄等建議。
18. **非主鍵 NOT NULL 注意事項**：若資料字典指定非主鍵欄位為 `NOT NULL`，建表腳本應避免重複宣告該限制。
19. **敏感欄位擴充**：欄位註解若表示姓名、地址等資訊（或欄位名含 `ADD`、`NM`、`NAME`），建立資料表時應將欄位長度放大三倍。
20. **儲存過程清空資料**：儲存過程中不得使用 `TRUNCATE TABLE`，需以 `ALTER TABLE ... WITH EMPTY` 等替代寫法避免高併發鎖表問題。
21. **多表關聯審查**：多表聯結查詢必須逐步驗證各步驟的資料量，避免產生笛卡兒積。

> **備註**：若後續需要擴充或調整規則，可更新 `sqlAnalyzer.js` 與對應的測試案例，同時同步此文件以維持文檔一致性。
